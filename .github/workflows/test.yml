name: test

run-name: ${{ github.actor }} is a test flow

on: [push]

jobs:
  load-env:
    uses: ./.github/workflows/load-env.yml

  checkout-repository:
    runs-on: self-hosted
    steps:
      - name: Check out repository code
        uses: actions/checkout@v3

#  build-rgl-host:
#    needs: checkout-repository
#    runs-on: self-hosted
#    steps:
#      - run: ./setup.py --build-dir build-host

  build-rgl-docker:
    needs: [checkout-repository, load-env]
    runs-on: self-hosted
    container:
      image: docker://localhost:5000/rgl:latest
      env:
        OptiX_INSTALL_DIR: /optix
        NVIDIA_DRIVER_CAPABILITIES: all
      volumes:
        - ${{ needs.load-env.outputs.base-image }}:/optix
      options:
        --rm
        --name rgl
        --gpus all
        --user ${{ needs.load-env.outputs.user }}
    steps:
      - run: pwd
      - run: ls
      - run: echo $OptiX_INSTALL_DIR
      - name: fix git
        run: git config --global --add safe.directory $PWD
      - run: ./setup.py --build-dir build-docker
